{% extends "base.html" %}

{% block title %}Nh·∫≠n di·ªán khu√¥n m·∫∑t{% endblock %}

{% block extra_css %}
<style>
    .model-selector {
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #007BFF;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .results-container {
        border: 2px solid #4CAF50;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
        background-color: rgba(76, 175, 80, 0.05);
    }

    .section-divider {
        margin: 15px 0;
        border-color: #4CAF50;
        opacity: 0.3;
    }

    .model-title {
        text-align: center;
        margin-bottom: 15px;
        color: #007BFF;
        font-weight: bold;
    }

    .pagination {
        justify-content: center;
        margin-top: 20px;
    }

    .pagination .page-item.active .page-link {
        background-color: #4CAF50;
        border-color: #4CAF50;
    }

    .chart-container {
        margin-bottom: 20px;
    }

    .chart-selector {
        margin-bottom: 15px;
    }

    .customer-card {
        margin-bottom: 20px;
    }

    .customer-images {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .customer-image {
        width: 24%;
        margin-bottom: 10px;
    }

    .metrics-badge {
        font-size: 0.8rem;
        margin-right: 5px;
    }

    .best-worst-images {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-danger" role="alert">
    {{ error }}
</div>
{% endif %}

<!-- Ph·∫ßn l·ª±a ch·ªçn m√¥ h√¨nh -->
<div class="model-selector">
    <h2 class="model-title">Ch·ªçn m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t</h2>

    <div class="row">
        <div class="col-md-12 text-center">
            <div class="btn-group" role="group">
                {% for method_key, method_name in detection_methods.items() %}
                <a href="/change_method/{{ method_key }}" class="btn btn-{% if method_key == selected_method %}primary{% else %}outline-primary{% endif %}">
                    {{ method_name }}
                </a>
                {% endfor %}
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#statsModal">
                    Th·ªëng k√™
                </button>
            </div>
        </div>
    </div>

    <!-- Modal hi·ªÉn th·ªã th·ªëng k√™ -->
    <div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="statsModalLabel">So s√°nh c√°c m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>M√¥ h√¨nh</th>
                                    <th>IoU trung b√¨nh</th>
                                    <th>Kho·∫£ng c√°ch t√¢m trung b√¨nh (px)</th>
                                    <th>Th·ªùi gian x·ª≠ l√Ω trung b√¨nh (s)</th>
                                    <th>S·ªë l∆∞·ª£ng ·∫£nh</th>
                                    <th>S·ªë ·∫£nh IoU k√©m (<0.5)</th>
                                    <th>T·ª∑ l·ªá ·∫£nh IoU k√©m</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for method_key, method_stats in all_models_stats.items() %}
                                <tr {% if method_key == selected_method %}class="table-active"{% endif %}>
                                    <td><strong>{{ method_stats.name }}</strong></td>
                                    <td>{{ method_stats.iou_mean }}</td>
                                    <td>{{ method_stats.center_dist_mean }}</td>
                                    <td>{{ method_stats.time_mean }}</td>
                                    <td>{{ method_stats.count }}</td>
                                    <td>{{ method_stats.poor_iou_count }}</td>
                                    <td>{{ method_stats.poor_iou_percent }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container cho k·∫øt qu·∫£ nh·∫≠n di·ªán -->
<div class="results-container">
    <!-- Face Detection Results -->
    <h3 class="text-center">üßë‚Äç‚ôÇÔ∏èüì∏ Face Detection Results</h3>

    <!-- Hi·ªÉn th·ªã kh√°ch h√†ng -->
    <div class="row">
        {% for customer in customers_data %}
        <div class="col-md-6 customer-card">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Kh√°ch h√†ng {{ customer.id }}</h5>
                </div>
                <div class="card-body">
                    <div class="customer-images">
                        {% for image in customer.images %}
                        <div class="customer-image">
                            <img src="data:image/png;base64,{{ image.base64 }}" class="img-fluid" alt="{{ image.name }}">
                            {% if image.metrics %}
                            <div class="mt-1">
                                <span class="badge bg-success metrics-badge">IoU: {{ image.metrics.iou }}</span>
                                <span class="badge bg-info metrics-badge">Dist: {{ image.metrics.center_dist }}px</span>
                                <span class="badge bg-warning metrics-badge">Time: {{ image.metrics.inference_time }}s</span>
                            </div>
                            {% else %}
                            <div class="mt-1">
                                <span class="badge bg-danger">No prediction</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Ph√¢n trang -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item {% if current_page == 0 %}disabled{% endif %}">
                <a class="page-link" href="/change_page/{{ current_page-1 }}?method={{ selected_method }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            {% for i in range(total_pages) %}
            <li class="page-item {% if i == current_page %}active{% endif %}">
                <a class="page-link" href="/change_page/{{ i }}?method={{ selected_method }}">{{ i + 1 }}</a>
            </li>
            {% endfor %}

            <li class="page-item {% if current_page == total_pages - 1 %}disabled{% endif %}">
                <a class="page-link" href="/change_page/{{ current_page+1 }}?method={{ selected_method }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>

    <hr class="section-divider">

    <!-- Face Detection Metrics Analysis -->
    <h3 class="text-center">üìà Face Detection Metrics Analysis</h3>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">IoU trung b√¨nh</h5>
                </div>
                <div class="card-body">
                    <h3>{{ stats.iou.mean }}</h3>
                    <p class="mb-0">
                        <small>Min: {{ stats.iou.min }}, Max: {{ stats.iou.max }}</small>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Kho·∫£ng c√°ch t√¢m trung b√¨nh</h5>
                </div>
                <div class="card-body">
                    <h3>{{ stats.center_dist.mean }} px</h3>
                    <p class="mb-0">
                        <small>Min: {{ stats.center_dist.min }} px, Max: {{ stats.center_dist.max }} px</small>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">Th·ªùi gian x·ª≠ l√Ω trung b√¨nh</h5>
                </div>
                <div class="card-body">
                    <h3>{{ stats.time.mean }} s</h3>
                    <p class="mb-0">
                        <small>Min: {{ stats.time.min }} s, Max: {{ stats.time.max }} s</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì ph√¢n t√≠ch -->
    <div class="chart-container">
        <div class="chart-selector">
            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="iou-tab" data-bs-toggle="tab" data-bs-target="#iou" type="button" role="tab" aria-controls="iou" aria-selected="true">IoU (Giao tr√™n h·ª£p)</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="center-dist-tab" data-bs-toggle="tab" data-bs-target="#center-dist" type="button" role="tab" aria-controls="center-dist" aria-selected="false">Kho·∫£ng c√°ch t√¢m</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="time-tab" data-bs-toggle="tab" data-bs-target="#time" type="button" role="tab" aria-controls="time" aria-selected="false">Th·ªùi gian x·ª≠ l√Ω</button>
                </li>
            </ul>
        </div>

        <div class="tab-content" id="chartTabsContent">
            <div class="tab-pane fade show active" id="iou" role="tabpanel" aria-labelledby="iou-tab">
                <img src="data:image/png;base64,{{ charts.iou }}" class="img-fluid" alt="IoU Distribution">
            </div>
            <div class="tab-pane fade" id="center-dist" role="tabpanel" aria-labelledby="center-dist-tab">
                <img src="data:image/png;base64,{{ charts.center_dist }}" class="img-fluid" alt="Center Distance Distribution">
            </div>
            <div class="tab-pane fade" id="time" role="tabpanel" aria-labelledby="time-tab">
                <img src="data:image/png;base64,{{ charts.time }}" class="img-fluid" alt="Inference Time Distribution">
            </div>
        </div>
    </div>

    <!-- B·∫£ng th·ªëng k√™ chi ti·∫øt -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-success">
                <tr>
                    <th>Th√¥ng s·ªë</th>
                    <th>Nh·ªè nh·∫•t</th>
                    <th>L·ªõn nh·∫•t</th>
                    <th>Trung b√¨nh</th>
                    <th>ƒê·ªô l·ªách chu·∫©n</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>IoU</td>
                    <td>{{ stats.iou.min }}</td>
                    <td>{{ stats.iou.max }}</td>
                    <td>{{ stats.iou.mean }}</td>
                    <td>{{ stats.iou.std }}</td>
                </tr>
                <tr>
                    <td>Kho·∫£ng c√°ch t√¢m (px)</td>
                    <td>{{ stats.center_dist.min }}</td>
                    <td>{{ stats.center_dist.max }}</td>
                    <td>{{ stats.center_dist.mean }}</td>
                    <td>{{ stats.center_dist.std }}</td>
                </tr>
                <tr>
                    <td>Th·ªùi gian x·ª≠ l√Ω (s)</td>
                    <td>{{ stats.time.min }}</td>
                    <td>{{ stats.time.max }}</td>
                    <td>{{ stats.time.mean }}</td>
                    <td>{{ stats.time.std }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr class="section-divider">

    <!-- ·∫¢nh c√≥ IoU l·ªõn nh·∫•t v√† nh·ªè nh·∫•t -->
    <h3 class="text-center">·∫¢nh c√≥ IoU l·ªõn nh·∫•t v√† nh·ªè nh·∫•t</h3>
    <p class="text-center"><strong>Ph∆∞∆°ng ph√°p nh·∫≠n di·ªán: {{ selected_method }}</strong></p>

    <div class="row best-worst-images">
        {% if best_worst_images and best_worst_images.best and best_worst_images.worst %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">IoU l·ªõn nh·∫•t: {{ best_worst_images.best_metrics.iou }}</h5>
                    </div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ best_worst_images.best }}" class="img-fluid" alt="Best IoU Image">
                        <p class="mt-2 mb-0">T·∫≠p tin: {{ best_worst_images.best_file }}</p>
                        <ul class="list-unstyled mt-2">
                            <li>Kho·∫£ng c√°ch t√¢m: {{ best_worst_images.best_metrics.center_dist }} px</li>
                            <li>Th·ªùi gian x·ª≠ l√Ω: {{ best_worst_images.best_metrics.inference_time }} s</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">IoU nh·ªè nh·∫•t: {{ best_worst_images.worst_metrics.iou }}</h5>
                    </div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ best_worst_images.worst }}" class="img-fluid" alt="Worst IoU Image">
                        <p class="mt-2 mb-0">T·∫≠p tin: {{ best_worst_images.worst_file }}</p>
                        <ul class="list-unstyled mt-2">
                            <li>Kho·∫£ng c√°ch t√¢m: {{ best_worst_images.worst_metrics.center_dist }} px</li>
                            <li>Th·ªùi gian x·ª≠ l√Ω: {{ best_worst_images.worst_metrics.inference_time }} s</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">IoU l·ªõn nh·∫•t: {{ best_iou.IoU }}</h5>
                    </div>
                    <div class="card-body">
                        <p class="mt-2 mb-0">T·∫≠p tin: {{ best_iou.file_name }}</p>
                        <ul class="list-unstyled mt-2">
                            <li>Kho·∫£ng c√°ch t√¢m: {{ best_iou.center_distance }} px</li>
                            <li>Th·ªùi gian x·ª≠ l√Ω: {{ best_iou.inference_time }} s</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">IoU nh·ªè nh·∫•t: {{ worst_iou.IoU }}</h5>
                    </div>
                    <div class="card-body">
                        <p class="mt-2 mb-0">T·∫≠p tin: {{ worst_iou.file_name }}</p>
                        <ul class="list-unstyled mt-2">
                            <li>Kho·∫£ng c√°ch t√¢m: {{ worst_iou.center_distance }} px</li>
                            <li>Th·ªùi gian x·ª≠ l√Ω: {{ worst_iou.inference_time }} s</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript ƒë·ªÉ x·ª≠ l√Ω c√°c t∆∞∆°ng t√°c tr√™n trang
    document.addEventListener('DOMContentLoaded', function() {
        // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab bi·ªÉu ƒë·ªì
        var chartTabs = document.querySelectorAll('#chartTabs button');
        chartTabs.forEach(function(tab) {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                var target = document.querySelector(this.getAttribute('data-bs-target'));

                // ·∫®n t·∫•t c·∫£ c√°c tab pane
                document.querySelectorAll('.tab-pane').forEach(function(pane) {
                    pane.classList.remove('show', 'active');
                });

                // Hi·ªÉn th·ªã tab pane ƒë∆∞·ª£c ch·ªçn
                target.classList.add('show', 'active');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i active c·ªßa c√°c tab
                chartTabs.forEach(function(t) {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });

                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
            });
        });
    });
</script>
{% endblock %}
